# Speech Therapy Bots
Изначально разрабатываемый для мобильного приложения "Привет, Логопед!" в рамках
хакатона, проект представляет собой кастомизируемых ботов для Telegram и VK, связанных
через единый бэкенд с админ-панелью Django.


## Функциональные цели проекта
Создать чат-боты в VK и Telegram с целью увеличения количества продаж через помощь и информирование пользователей, а также для оптимизации работы автора проекта.


## Основные возможности
* Настраиваемое через админ-панель меню ботов под разные роли пользоваталей.
* Информационные кнопки: выдача текстов, ссылок и файлов.
* Возможность создавать вложенные меню.
* Связь с администраторами.
* Админ-функционал в ботах для оперативных ответов на вопросы и блокировку пользователей.
* Админ-панель для ответов на большое количество вопросов и управление проектом.


## Достигнутые требования
* Админ-панель с настраиваемыми меню под разные роли.
* Навигация по меню.
* Информационные кнопки: выдача текстов и файлов.
* Вопросы пользователей администраторам.
* Полная интернационализация.
* Ответы администраторов пользователям (не более 1 администратора одновременно).
* Рассылка ответов пользователям (только Telegram).
* Подписка на рассылку (Telegram — частично).
* Смена роли пользователя (только VK).
* Минимальная система логирования ошибок.


## Структура проекта
* `/infra` — Директория с файлами для деплоя на сервер.
* `/backend` — Основная директория со стандартной структурой django-проекта.

Файлы с настройками:
* `/backend/settings.py` — Основные настройки.
* `/core/localization.py` — Все тексты локализации.


## Технологии
* Python 3.11
* Django 4.2
* python-telegram-bot 13.7
* vk_api 11.9
* PostgreSQL 16.3
* gunicorn 23.0


## Установка и запуск

### Telegram бот
#### 1. Создание бота:
- Откройте мессенджер [Telegram](https://telegram.org/apps), войдите в вашу учётную запись или создайте новую.
- Введите в поле поиска [@BotFather](https://telegram.me/BotFather) и выберите бота.

>У официального бота Telegram будет стоять синий подтверждающий знак возле имени в виде галочки.

- Нажмите `Запустить` или отправьте в чат команду `/start` для активации бота `BotFather`.

В ответ вы получите список команд по управлению ботом.

- Выберите или напечатайте и отправьте команду `/newbot`.
- Дайте `имя` боту — пользователи увидят это имя при общении с ботом.
- Далее укажите `никнейм` бота — по нему можно будет найти бота в Telegram. Никнейм должен быть уникальным, не повторять существующие и заканчиваться на слово `bot`, например, `TelegramBot` или `tg_bot`.

>`Имя` может быть любым. Нестрашно, если оно будет дублировать уже существующие.

- После того, как вы выберите подходящее имя, бот будет создан. Вы получите сообщение со ссылкой на бота `t.me/<никнейм_бота>`, рекомендации по настройке аватарки, описание бота, список команд для его настройки, и - самое главное - вы получите `токен`.

#### 2. Как получить `токен` для уже существующего бота:
- Перейдите к боту `@BotFather` и введите команду `/token`. Вы увидите кнопки с `никнеймами` созданных ботов.
- Выберите бота, чей токен нужно получить.
- Скопируйте полученный от `@BotFather` `токен` для вашего бота.

### VK бот
#### 1. Подготовка группы ВК:
- Зайдите на главную страницу группы с аккаунта администратора и выберите на боковой панели `Управление`.
- Перейдите в раздел `Настройки` -> `Работа с API`.
- Нажмите `Создать ключ` и разрешите доступ к *управлению сообществом*, *сообщениям сообщества* и *документам сообщества*. Этот ключ пригодится в будущем.
- В разделе `Настройки` -> `Работа с API` откройте вкладку `Long Poll API` и включите его.
- В той же вкладке откройте `Типы событий` и отметьте все пункты под заголовками *Сообщения* и *Пользователи*.
- В боковом меню выйдите из раздела `Настройки` -> `Работа с API`, откройте раздел `Сообщения` и включите *Сообщения сообщества*.
- Перейдите в раздел `Сообщения` -> `Настройки для бота`.
- Включите *Возможности ботов* и отметьте пункт *Добавить кнопку «Начать»*.

#### 2. Получения данных для `.env`:
- `Токен` для бота ВК был создан на предыдущем этапе и сейчас хранится в разделе `Настройки` -> `Работа с API` -> `Ключи доступа`. Нажмите на кнопку *Показать* напротив него.
- `ID` группы ВК - это набор цифр, которыми заканчивается адрес группы: https://vk.com/club`XXXXXX`


### Запуск проекта локально
- Добавьте `токен` телеграм-бота, `токен` вк бота и `id` вк группы в файл с переменными окружения `.env`, расположенный в головной директории проекта, а если этого файла нет, то создайте его по примеру файла `.env.example`.
- Укажите `SQLITE=True` и `DEBUG=True`.

```
SQLITE=True
DEBUG=True
VK_TOKEN=Ваш токен из Ключей доступа (ВК)
VK_GROUP_ID=ID группы (ВК)
TELEGRAM_TOKEN=Ваш токен от BotFather (Telegram)
```

- Перейдите в головную директорию проекта `SpeechTherapyBots` и активируйте там виртуальное окружение:

Для `MacOS` или `Linux`
```
python3 -m venv venv
source venv/bin/activate
```
Для `Windows`
```
python -m venv venv
source venv/Scripts/activate
```
- Обновите менеджер пакетов pip:
```
pip install --upgrade pip 
```
- Установите зависимости:
```
pip install -r requirements.txt
```

- Убедитесь, что у вас применены все необходимые миграции. Это можно 
  сделать из головной директории проекта с помощью команды:

Для `MacOS` или `Linux`
```
python3 backend/manage.py migrate
```
Для `Windows`
```
python backend/manage.py migrate
```
- Для создания учётной записи администратора выполните команду:

Для `MacOS` или `Linux`
```
python3 backend/manage.py createsuperuser
```
Для `Windows`
```
python backend/manage.py createsuperuser
```

- Для запуска Telegram-бота из той же директории выполните команду:

Для `MacOS` или `Linux`
```
python3 backend/manage.py telegram_bot
```
Для `Windows`
```
python backend/manage.py telegram_bot
```
- Для запуска VK-бота из той же директории выполните команду:

Для `MacOS` или `Linux`
```
python3 backend/manage.py vk_bot
```
Для `Windows`
```
python backend/manage.py vk_bot
```


### Деплой на сервер
>NB: Инструкция приведена для debian-based дистрибутива Linux!

#### 1. Убедитесь, что на сервере установлены все необходимые пакеты.

```
sudo apt update
sudo apt install git python3 python3-pip python3-venv nano postgresql systemd
```

#### 2. Настройте базу данных PostgreSQL.

- Запустите системную службу postgresql и включите её для автоматического запуска при загрузке сервера.
```
sudo systemctl enable --now postgresql
```

- Создайте пользователя, от имени которого будет использоваться база данных.
```
sudo -su postgres createuser <имя_пользователя>
```

- Создайте базу данных и укажите её владельцем ранее созданного пользователя.
```
sudo -su postgres createdb <название_базы_данных> -O <имя_пользователя>
```

- Задайте пароль для созданного пользователя.
```
sudo -u postgres psql -c "ALTER USER <имя_пользователя> PASSWORD '<пароль_пользователя>';"
```

#### 3. Клонируйте репозиторий и настройте проект перед первым запуском.

- Клонируйте репозиторий на сервер и перейдите в его корневую директорию.
```
git clone git@github.com:zhmur-dev/SpeechTherapyBots.git
cd SpeechTherapyBots/
```

- Создайте и заполните файл `.env` по образцу из `.env.example`. Название базы данных (`DATABASE_NAME`), имя пользователя (`POSTGRES_USER`) и пароль (`POSTGRES_PASSWORD`) Вы задали ранее на шаге 2. Не забудьте также указать актуальный адрес Вашего сервера в `ALLOWED_HOSTS`.
```
nano .env
```

#### 4. Создайте и активируйте виртуальное окружение, установите зависимости и примените все нужные миграции.
```
cd backend/
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r ../requirements.txt
python3 manage.py collectstatic
python3 manage.py migrate
```

#### 5. Создайте учётную запись первого пользователя-администратора.
```
python3 manage.py createsuperuser
```

#### 6. Настройте инфраструктуру.
Отредактируйте файлы `backend.service`, `telegram-bot.service` и `vk-service` из директории `infra` и поместите их 
в `/etc/systemd/system/` на Вашем сервере. (При редактировании необходимо указать абсолютный путь до директории 
с проектом на Вашем сервере и имя пользователя на Вашем сервере, от имени которого будет осуществляться запуск демонов.)

```
nano ../infra/backend.service
nano ../infra/telegram-bot.service
nano ../infra/vk-bot.service
sudo cp ../infra/backend.service ../infra/telegram-bot.service ../infra/vk-bot.service /etc/systemd/system
```

#### 7. Запустите созданные службы и включите их в автоматический запуск при перезагрузке сервера.
```
sudo systemctl enable --now backend
sudo systemctl enable --now telegram-bot
sudo systemctl enable --now vk-bot
```

Проект готов к работе на Вашем удалённом сервере!


## Авторы
* Евгений [MicroElf](https://github.com/MicroElf) Черных - Team Leader
* Александр [zhmur-dev](https://github.com/zhmur-dev) Жмурков - Backend
* Денис [KrDenches](https://github.com/KrDenches) Крохин - Telegram
* Всеволод [Vsevolod25](https://github.com/Vsevolod25) Колупатин - VK
